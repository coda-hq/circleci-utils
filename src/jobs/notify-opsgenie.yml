description: >
  Notify opsgenie through API of circleci failure/success

executor: default

parameters:
  CODA_USER_ROSTER_TABLE_URL:
    description: |
      Fully qualified API URL to a table containing CIRCLECI_USERNAMEs to email aliases.    Must be of the form
      https://coda.io/apis/v1/docs/<DOCID>/tables/<TABLEID>/rows.
    type: string
    default: https://staging.coda.io/apis/v1/docs/s2i6oFeghW/tables/grid-QGyaiXZDwu/rows
  CODA_API_TOKEN:
    description: |
      Env var of a token granted read access to the CODA_USER_ROSTER_TABLE_URL document.
    type: string
  CODA_CIRCLECI_USER_NAME_COL:
    description: |
      Coda columnId of the column storing the CircleCI username.
    type: string
    default: c-6ni4kHGNwE
  CODA_CIRCLECI_USER_ALIAS_COL:
    description: |
      Coda columnId of the column storing the user alias (when using EMAIL_DOMAIN), or fully qualified email.
    type: string
    default: c-26If9Zttyp
  EMAIL_DOMAIN:
    description: |
      Optional email domain for users within the workspace.   Must be specified if user aliases are not fully qualified.
    type: string
    default: coda.io

steps: 
  - grab-email:
      CODA_API_TOKEN: << parameters.CODA_API_TOKEN >>
      CODA_CIRCLECI_USER_ALIAS_COL: << parameters.CODA_CIRCLECI_USER_ALIAS_COL >>
      CODA_CIRCLECI_USER_NAME_COL: << parameters.CODA_CIRCLECI_USER_NAME_COL >>
      CODA_USER_ROSTER_TABLE_URL: << parameters.CODA_USER_ROSTER_TABLE_URL >>
      EMAIL_DOMAIN: << parameters.EMAIL_DOMAIN >>
  - notify:
      email: $USER_EMAIL
      on_failure: true
      diff_url: $DIFF_URL